<!--pages/messages/messages.wxml-->
<view class="messages-page">
  <!-- é¡µé¢å¤´éƒ¨ -->
  <view class="page-header">
    <view class="header-left">
      <view class="unread-badge {{unreadCount > 0 ? 'has-unread' : ''}}">
        <text>{{unreadCount}} æœªè¯»æ¶ˆæ¯</text>
      </view>
    </view>
    <text class="title">æ¶ˆæ¯ä¸­å¿ƒ</text>

  </view>

  <!-- å‘é€æ¶ˆæ¯æŒ‰é’® -->
  <view class="send-message-section">
    <button class="send-message-btn" bindtap="openSendMessageDialog">
      <text class="send-icon">ğŸ“¢</text>
      <text>å‘é€é‡è¦æ¶ˆæ¯</text>
    </button>
  </view>

  <!-- æµ‹è¯•æ¨¡å¼æŒ‡ç¤ºå™¨ -->
  <view wx:if="{{testMode}}" class="test-mode-indicator">
    <text>æµ‹è¯•æ¨¡å¼ï¼šæ˜¾ç¤º20æ¡æ¨¡æ‹Ÿæ¶ˆæ¯æ•°æ®</text>
  </view>

  <!-- æ¶ˆæ¯åˆ—è¡¨ -->
  <scroll-view class="alerts-list" scroll-y>
    <view wx:for="{{displayAlerts}}" wx:key="id" class="alert-card {{item.read ? 'read' : ''}}" bindtap="showAlertDetail" data-alert="{{item}}">
      <view class="alert-content">
        <view class="alert-header">
          <view class="device-info">
            <text class="alert-icon">ğŸ””</text>
            <text class="device-name">{{getDeviceName(item)}}</text>
          </view>
          <view class="severity-badge" style="background-color: {{getSeverityColor(item.level)}}">
            <text>{{getSeverityText(item.level)}}</text>
          </view>
        </view>

        <text class="alert-message">{{item.message}}</text>

        <view class="alert-footer">
          <text class="timestamp">{{formatTimestamp(item.timestamp)}}</text>
          <view wx:if="{{!item.read}}" class="alert-status">
            <button class="mark-read-btn" bindtap="markAsRead" data-id="{{item.id}}" catchtap="stopPropagation">
              <text>æ ‡è®°å·²è¯»</text>
            </button>
          </view>
          <view wx:else class="alert-status">
            <text class="status-text read">å·²è¯»</text>
          </view>
        </view>
      </view>
    </view>

    <view wx:if="{{displayAlerts.length === 0 && !loading}}" class="empty-state">
      <text class="empty-icon">ğŸ“­</text>
      <text class="empty-text">æš‚æ— æ¶ˆæ¯æ•°æ®</text>
    </view>
  </scroll-view>

  <!-- æ¶ˆæ¯è¯¦æƒ…æ¨¡æ€æ¡† -->
  <view wx:if="{{showDetailModal && selectedAlert}}" class="modal-overlay" bindtap="closeDetailModal">
    <view class="modal-content" catchtap="stopPropagation">
      <view class="modal-header">
        <text class="modal-title">æ¶ˆæ¯è¯¦æƒ…</text>
        <button class="close-btn" bindtap="closeDetailModal">Ã—</button>
      </view>

      <view class="modal-body">
        <view class="detail-section">
          <text class="section-title">åŸºæœ¬ä¿¡æ¯</text>
          <view class="detail-grid">
            <view class="detail-item">
              <text class="detail-label">è®¾å¤‡åç§°:</text>
              <text class="detail-value">{{getDeviceName(selectedAlert)}}</text>
            </view>
            <view class="detail-item">
              <text class="detail-label">ä¸¥é‡ç¨‹åº¦:</text>
              <view class="severity-badge" style="background-color: {{getSeverityColor(selectedAlert.level)}}">
                <text>{{getSeverityText(selectedAlert.level)}}</text>
              </view>
            </view>
            <view class="detail-item">
              <text class="detail-label">æ¶ˆæ¯å†…å®¹:</text>
              <text class="detail-value">{{selectedAlert.message}}</text>
            </view>
            <view class="detail-item">
              <text class="detail-label">æ—¶é—´:</text>
              <text class="detail-value">{{formatTimestamp(selectedAlert.timestamp)}}</text>
            </view>
          </view>
        </view>

        <view wx:if="{{selectedAlert.parsed_data}}" class="detail-section">
          <text class="section-title">è§£ææ•°æ®</text>
          <view class="parsed-data-container">
            <text class="parsed-data-content">{{selectedAlert.parsed_data}}</text>
          </view>
        </view>
      </view>

      <view class="modal-actions">
        <button class="action-btn secondary" bindtap="closeDetailModal">å…³é—­</button>
        <button wx:if="{{!selectedAlert.read}}" class="action-btn primary" bindtap="markAsRead" data-id="{{selectedAlert.id}}">
          æ ‡è®°ä¸ºå·²è¯»
        </button>
      </view>
    </view>
  </view>

  <!-- å‘é€æ¶ˆæ¯å¯¹è¯æ¡† -->
  <view wx:if="{{showSendMessageDialog}}" class="modal-overlay" bindtap="closeSendMessageDialog">
    <view class="modal-content send-message-dialog" catchtap="stopPropagation">
      <view class="modal-header">
        <text class="modal-title">å‘é€é‡è¦æ¶ˆæ¯</text>
        <button class="close-btn" bindtap="closeSendMessageDialog">Ã—</button>
      </view>

      <view class="modal-body">
        <view class="form-group">
          <textarea
            class="message-textarea"
            placeholder="è¯·è¾“å…¥è¦å‘é€çš„é‡è¦æ¶ˆæ¯å†…å®¹..."
            value="{{messageContent}}"
            bindinput="onMessageContentInput"
            maxlength="500"
            disabled="{{sendingMessage}}"
          ></textarea>
          <view class="char-count">{{messageContent.length}}/500</view>
        </view>

        <view wx:if="{{sendMessageError}}" class="error-message">
          <text>{{sendMessageError}}</text>
        </view>

        <view wx:if="{{sendMessageSuccess}}" class="success-message">
          <text>æ¶ˆæ¯å‘é€æˆåŠŸï¼</text>
        </view>
      </view>

      <view class="modal-actions">
        <button class="action-btn secondary" bindtap="closeSendMessageDialog" disabled="{{sendingMessage}}">
          å–æ¶ˆ
        </button>
        <button class="action-btn primary" bindtap="sendImportantMessage" disabled="{{sendingMessage || !messageContent.trim()}}">
          <text wx:if="{{sendingMessage}}">å‘é€ä¸­...</text>
          <text wx:else>å‘é€</text>
        </button>
      </view>
    </view>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{loading}}" class="loading-overlay">
    <view class="loading-spinner">
      <text>åŠ è½½ä¸­...</text>
    </view>
  </view>
</view>
