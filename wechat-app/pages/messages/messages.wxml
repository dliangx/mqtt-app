<!--pages/messages/messages.wxml-->
<wxs src="../../utils/messages.wxs" module="msg" />
<view class="messages-page">
  <!-- é¡µé¢å¤´éƒ¨ -->
  <view class="page-header">
    <view class="header-left">
      <view class="unread-badge {{unreadCount > 0 ? 'has-unread' : ''}}">
        <text>{{unreadCount}} æœªè¯»æ¶ˆæ¯</text>
      </view>
    </view>
    <text class="title">æ¶ˆæ¯ä¸­å¿ƒ</text>

  </view>

  <!-- å‘é€æ¶ˆæ¯æŒ‰é’® -->
  <view class="send-message-section">
    <button class="send-message-btn" bindtap="openSendMessageDialog">
      <text class="send-icon">ğŸ“¢</text>
      <text>å‘é€é‡è¦æ¶ˆæ¯</text>
    </button>
  </view>



  <!-- æ¶ˆæ¯åˆ—è¡¨ -->
  <scroll-view class="alerts-list" scroll-y bindscrolltolower="onScrollToLower">
    <!-- éª¨æ¶å±æ˜¾ç¤ºåŒºåŸŸ -->
    <view wx:if="{{loading && displayAlerts.length === 0}}">
      <view class="skeleton-card" wx:for="{{[1,2,3,4,5]}}" wx:key="*this">
        <view class="skeleton-header">
          <view class="skeleton-avatar"></view>
          <view class="skeleton-line short"></view>
          <view class="skeleton-badge"></view>
        </view>
        <view class="skeleton-line long"></view>
        <view class="skeleton-line medium"></view>
        <view class="skeleton-footer">
          <view class="skeleton-line tiny"></view>
          <view class="skeleton-button"></view>
        </view>
      </view>
    </view>

    <!-- å®é™…æ¶ˆæ¯åˆ—è¡¨ -->
    <view wx:if="{{!loading || displayAlerts.length > 0}}" wx:for="{{displayAlerts}}" wx:key="id" class="alert-card {{item.read ? 'read' : ''}}" bindtap="showAlertDetail" data-alert="{{item}}">
      <view class="alert-content">
        <view class="alert-header">
          <view class="device-info">
            <text class="alert-icon">ğŸ””</text>
            <text class="device-name">{{item.device_id}}</text>
          </view>
          <view class="severity-badge" style="background-color: {{msg.getSeverityColor(item.level)}}">
            <text>{{msg.getSeverityText(item.level)}}</text>
          </view>
        </view>
        <text class="alert-message">{{item.message}}</text>
        <view class="alert-footer">
          <text class="timestamp">{{msg.formatTimestamp(item.timestamp)}}</text>
          <view wx:if="{{!item.read}}" class="alert-status">
            <text class="status-text unread">æœªè¯»</text>
          </view>
          <view wx:else class="alert-status">
            <text class="status-text read">å·²è¯»</text>
          </view>
        </view>
      </view>
    </view>

    <view wx:if="{{displayAlerts.length === 0 && !loading}}" class="empty-state">
      <text class="empty-icon">ğŸ“­</text>
      <text class="empty-text">æš‚æ— æ¶ˆæ¯æ•°æ®</text>
    </view>

    <!-- åŠ è½½æ›´å¤š -->
    <view wx:if="{{loadingMore}}" class="load-more">
      <view class="loading-spinner">
        <text>åŠ è½½ä¸­...</text>
      </view>
    </view>

    <view wx:if="{{!loadingMore && hasMore}}" class="load-more">
      <text class="load-more-text">ä¸Šæ‹‰åŠ è½½æ›´å¤š</text>
    </view>

    <view wx:if="{{!loadingMore && !hasMore && displayAlerts.length > 0}}" class="load-more">
      <text class="load-more-text">æ²¡æœ‰æ›´å¤šæ¶ˆæ¯äº†</text>
    </view>
  </scroll-view>

  <!-- æ¶ˆæ¯è¯¦æƒ…æ¨¡æ€æ¡† -->
  <view wx:if="{{showDetailModal && selectedAlert}}" class="modal-overlay" bindtap="closeDetailModal">
    <view class="modal-content" catchtap="stopPropagation">
      <view class="modal-header">
        <text class="modal-title">æ¶ˆæ¯è¯¦æƒ…</text>
        <button class="close-btn" bindtap="closeDetailModal">Ã—</button>
      </view>

      <view class="modal-body">
        <view class="detail-section">
          <text class="section-title">åŸºæœ¬ä¿¡æ¯</text>
          <view class="detail-grid">
            <view class="detail-item">
              <text class="detail-label">è®¾å¤‡ID:</text>
              <text class="detail-value">{{selectedAlert.device_id}}</text>
            </view>
            <view class="detail-item">
              <text class="detail-label">ä¸¥é‡ç¨‹åº¦:</text>
              <view class="severity-badge" style="background-color: {{msg.getSeverityColor(selectedAlert.level)}}">
                <text>{{msg.getSeverityText(selectedAlert.level)}}</text>
              </view>
            </view>
            <view class="detail-item">
              <text class="detail-label">æ¶ˆæ¯å†…å®¹:</text>
              <text class="detail-value">{{selectedAlert.message}}</text>
            </view>
            <view class="detail-item">
              <text class="detail-label">æ—¶é—´:</text>
              <text class="detail-value">{{msg.formatTimestamp(selectedAlert.timestamp)}}</text>
            </view>
          </view>
        </view>

        <view wx:if="{{selectedAlert.parsed_data}}" class="detail-section">
          <text class="section-title">è§£ææ•°æ®</text>
          <view class="parsed-data-container">
            <text class="parsed-data-content">{{selectedAlert.parsed_data}}</text>
          </view>
        </view>
      </view>

      <view class="modal-actions">
        <button class="action-btn secondary" bindtap="closeDetailModal">å…³é—­</button>
        <button wx:if="{{!selectedAlert.read}}" class="action-btn primary" bindtap="markAsRead" data-id="{{selectedAlert.ID}}">
          æ ‡è®°ä¸ºå·²è¯»
        </button>
      </view>
    </view>
  </view>

  <!-- å‘é€æ¶ˆæ¯å¯¹è¯æ¡† -->
  <view wx:if="{{showSendMessageDialog}}" class="modal-overlay" bindtap="closeSendMessageDialog">
    <view class="modal-content send-message-dialog" catchtap="stopPropagation">
      <view class="modal-header">
        <text class="modal-title">å‘é€é‡è¦æ¶ˆæ¯</text>
        <button class="close-btn" bindtap="closeSendMessageDialog">Ã—</button>
      </view>

      <view class="modal-body">
        <view class="form-group">
          <textarea
            class="message-textarea"
            placeholder="è¯·è¾“å…¥è¦å‘é€çš„é‡è¦æ¶ˆæ¯å†…å®¹..."
            value="{{messageContent}}"
            bindinput="onMessageContentInput"
            maxlength="500"
            disabled="{{sendingMessage}}"
          ></textarea>
          <view class="char-count">{{messageContent.length}}/500</view>
        </view>

        <view wx:if="{{sendMessageError}}" class="error-message">
          <text>{{sendMessageError}}</text>
        </view>

        <view wx:if="{{sendMessageSuccess}}" class="success-message">
          <text>æ¶ˆæ¯å‘é€æˆåŠŸï¼</text>
        </view>
      </view>

      <view class="modal-actions">
        <button class="action-btn secondary" bindtap="closeSendMessageDialog" disabled="{{sendingMessage}}">
          å–æ¶ˆ
        </button>
        <button class="action-btn primary" bindtap="sendImportantMessage" disabled="{{sendingMessage || !messageContent.trim()}}">
          <text wx:if="{{sendingMessage}}">å‘é€ä¸­...</text>
          <text wx:else>å‘é€</text>
        </button>
      </view>
    </view>
  </view>

  <!-- ç§»é™¤å…¨å±€çš„åŠ è½½çŠ¶æ€ï¼Œå› ä¸ºæˆ‘ä»¬ç°åœ¨æœ‰éª¨æ¶å±äº† -->
  <!-- <view wx:if="{{loading}}" class="loading-overlay">
    <view class="loading-spinner">
      <text>åŠ è½½ä¸­...</text>
    </view>
  </view> -->
</view>
