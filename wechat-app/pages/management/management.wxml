<!--pages/management/management.wxml-->
<wxs src="../../utils/time.wxs" module="time" />
<view class="management-page">

  <!-- é¡µé¢å¤´éƒ¨ -->
  <view class="page-header">
    <text class="title">è®¾å¤‡ç®¡ç†</text>

  </view>
  <view class="add-btn" bindtap="openAddDialog">
      <text class="add-icon">+</text>
      <text>æ·»åŠ è®¾å¤‡</text>

    </view>
  <!-- å†…å®¹åŒºåŸŸ -->
  <view class="content">

    <!-- è®¾å¤‡åˆ—è¡¨ -->
    <scroll-view class="device-list" scroll-y>
      <view wx:for="{{devices}}" wx:key="ID" class="device-card">
        <view class="card-content">
          <!-- è®¾å¤‡å¤´éƒ¨ä¿¡æ¯ -->
          <view class="device-header">
            <text class="device-name">{{item.name}}</text>
            <view class="status-badge {{item.status}}">
              <text>{{time.getStatusText(item.status)}}</text>
            </view>
          </view>

          <!-- è®¾å¤‡åŸºæœ¬ä¿¡æ¯ -->
          <view class="device-info">
            <view class="info-row">
              <text class="info-label">ä¸»é¢˜:</text>
              <text class="info-value">{{item.topic}}</text>
            </view>
            <view class="info-row">
              <text class="info-label">è®¾å¤‡ç»„:</text>
              <text class="info-value">{{time.getGroupName(item.group_id, deviceGroups)}}</text>
            </view>
            <view wx:if="{{item.longitude && item.latitude}}" class="info-row">
              <text class="info-label">ä½ç½®:</text>
              <text class="info-value">{{item.longitude}}, {{item.latitude}}</text>
            </view>
            <view wx:if="{{item.address}}" class="info-row">
              <text class="info-label">åœ°å€:</text>
              <text class="info-value">{{item.address}}</text>
            </view>
            <view class="info-row">
              <text class="info-label">æœ€ååœ¨çº¿:</text>
              <text class="info-value">{{item.last_seen !== undefined && item.last_seen !== null ? time.formatDateTime(item.last_seen) : 'ä»æœªåœ¨çº¿'}}</text>
            </view>
          </view>

          <!-- è®¾å¤‡æ“ä½œæŒ‰é’® -->
          <view class="device-actions">
            <button class="edit-btn" bindtap="openEditDialog" data-device="{{item}}">
              <text>ç¼–è¾‘</text>
            </button>
            <button class="delete-btn" bindtap="handleDeleteDevice" data-id="{{item.ID}}">
              <text>åˆ é™¤</text>
            </button>
          </view>
        </view>
      </view>

      <!-- ç©ºçŠ¶æ€ -->
      <view wx:if="{{devices.length === 0 && !loading}}" class="empty-state">
        <text class="empty-icon">ğŸ“±</text>
        <text class="empty-text">æš‚æ— è®¾å¤‡</text>
        <text class="empty-desc">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ ç¬¬ä¸€ä¸ªè®¾å¤‡</text>
      </view>
    </scroll-view>
  </view>

  <!-- æ·»åŠ è®¾å¤‡å¯¹è¯æ¡† -->
  <view wx:if="{{addDeviceDialog}}" class="modal-overlay" bindtap="closeAddDialog">
    <view class="modal-content" catchtap="stopPropagation">
      <view class="modal-header">
        <text class="modal-title">æ·»åŠ è®¾å¤‡</text>
        <button class="close-btn" bindtap="closeAddDialog">Ã—</button>
      </view>

      <view class="modal-body">
        <form bindsubmit="handleAddDevice">
          <view class="form-group">
            <label class="form-label">è®¾å¤‡åç§°</label>
            <input
              class="form-input"
              type="text"
              name="name"
              value="{{newDevice.name}}"
              placeholder="è¯·è¾“å…¥è®¾å¤‡åç§°"
              maxlength="50"
            />
          </view>

          <view class="form-group">
            <label class="form-label">è®¾å¤‡ä¸»é¢˜</label>
            <input
              class="form-input"
              type="text"
              name="topic"
              value="{{newDevice.topic}}"
              placeholder="è¯·è¾“å…¥è®¾å¤‡ä¸»é¢˜"
              maxlength="100"
            />
          </view>

          <view class="form-group">
            <label class="form-label">è®¾å¤‡ç»„</label>
            <picker
              class="form-picker"
              range="{{deviceGroups}}"
              range-key="name"
              value="{{newDevice.group_id}}"
              bindchange="onGroupChange"
            >
              <view class="picker-value">
                {{newDevice.group_id ? time.getGroupName(newDevice.group_id, deviceGroups) : 'è¯·é€‰æ‹©è®¾å¤‡ç»„'}}
              </view>
            </picker>
          </view>

          <view class="form-row">
            <view class="form-group">
              <label class="form-label">ç»åº¦</label>
              <input
                class="form-input"
                type="number"
                name="longitude"
                value="{{newDevice.longitude}}"
                placeholder="è¯·è¾“å…¥ç»åº¦"
                step="0.000001"
              />
            </view>
            <view class="form-group">
              <label class="form-label">çº¬åº¦</label>
              <input
                class="form-input"
                type="number"
                name="latitude"
                value="{{newDevice.latitude}}"
                placeholder="è¯·è¾“å…¥çº¬åº¦"
                step="0.000001"
              />
            </view>
          </view>

          <view class="form-actions">
            <button class="cancel-btn" bindtap="closeAddDialog" type="button">å–æ¶ˆ</button>
            <button class="confirm-btn" formType="submit">
              <text>æ·»åŠ è®¾å¤‡</text>
            </button>
          </view>
        </form>
      </view>
    </view>
  </view>

  <!-- ç¼–è¾‘è®¾å¤‡å¯¹è¯æ¡† -->
  <view wx:if="{{editDeviceDialog}}" class="modal-overlay" bindtap="closeEditDialog">
    <view class="modal-content" catchtap="stopPropagation">
      <view class="modal-header">
        <text class="modal-title">ç¼–è¾‘è®¾å¤‡</text>
        <button class="close-btn" bindtap="closeEditDialog">Ã—</button>
      </view>

      <view class="modal-body">
        <form bindsubmit="handleEditDevice">
          <view class="form-group">
            <label class="form-label">è®¾å¤‡åç§°</label>
            <input
              class="form-input"
              type="text"
              name="name"
              value="{{editingDevice.name}}"
              placeholder="è¯·è¾“å…¥è®¾å¤‡åç§°"
              maxlength="50"
            />
          </view>

          <view class="form-group">
            <label class="form-label">è®¾å¤‡ä¸»é¢˜</label>
            <input
              class="form-input"
              type="text"
              name="topic"
              value="{{editingDevice.topic}}"
              placeholder="è¯·è¾“å…¥è®¾å¤‡ä¸»é¢˜"
              maxlength="100"
            />
          </view>

          <view class="form-group">
            <label class="form-label">è®¾å¤‡ç»„</label>
            <picker
              class="form-picker"
              range="{{deviceGroups}}"
              range-key="name"
              value="{{editingDevice.group_id}}"
              bindchange="onEditGroupChange"
            >
              <view class="picker-value">
                {{editingDevice.group_id ? time.getGroupName(editingDevice.group_id, deviceGroups) : 'è¯·é€‰æ‹©è®¾å¤‡ç»„'}}
              </view>
            </picker>
          </view>

          <view class="form-row">
            <view class="form-group">
              <label class="form-label">ç»åº¦</label>
              <input
                class="form-input"
                type="number"
                name="longitude"
                value="{{editingDevice.longitude}}"
                placeholder="è¯·è¾“å…¥ç»åº¦"
                step="0.000001"
              />
            </view>
            <view class="form-group">
              <label class="form-label">çº¬åº¦</label>
              <input
                class="form-input"
                type="number"
                name="latitude"
                value="{{editingDevice.latitude}}"
                placeholder="è¯·è¾“å…¥çº¬åº¦"
                step="0.000001"
              />
            </view>
          </view>

          <view class="form-actions">
            <button class="cancel-btn" bindtap="closeEditDialog" type="button">å–æ¶ˆ</button>
            <button class="confirm-btn" formType="submit">
              <text>ä¿å­˜ä¿®æ”¹</text>
            </button>
          </view>
        </form>
      </view>
    </view>
  </view>

  <!-- æç¤ºæ¶ˆæ¯ -->
  <view wx:if="{{error}}" class="snackbar error">
    <text class="snackbar-message">{{error}}</text>
    <button class="snackbar-close" bindtap="clearError">Ã—</button>
  </view>

  <view wx:if="{{success}}" class="snackbar success">
    <text class="snackbar-message">{{success}}</text>
    <button class="snackbar-close" bindtap="clearSuccess">Ã—</button>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{loading}}" class="loading-overlay">
    <view class="loading-spinner">
      <text>åŠ è½½ä¸­...</text>
    </view>
  </view>
</view>
