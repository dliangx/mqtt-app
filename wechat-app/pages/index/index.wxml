<!--pages/monitor/monitor.wxml-->
<wxs src="../../utils/time.wxs" module="time" />
<view class="monitor-page">

  <!-- 地图容器 -->
  <view class="map-container">
    <map
      id="map"
      longitude="{{currentLocation ? currentLocation.longitude : 116.3974}}"
      latitude="{{currentLocation ? currentLocation.latitude : 39.9093}}"
      scale="14"
      markers="{{markers}}"
      bindmarkertap="handleMarkerClick"
      show-location
      style="width: 100%; height: 100%;"
    >
    </map>
  </view>





  <!-- 设备详情对话框 -->
  <view wx:if="{{dialogOpen && selectedDevice}}" class="dialog-overlay" bindtap="handleCloseDialog">
    <view class="dialog" catchtap="stopPropagation">
      <view class="dialog-header">
        <text class="dialog-title">设备详情 - {{selectedDevice.name}}</text>
        <view class="close-btn" bindtap="handleCloseDialog">×</view>
      </view>

      <view class="dialog-content">
        <view class="device-detail">
          <view class="detail-row">
            <text class="detail-label">设备名称:</text>
            <text class="detail-value">{{selectedDevice.name}}</text>
          </view>
          <view class="detail-row">
          <text class="detail-label">设备状态:</text>
          <view class="status-badge {{selectedDevice.status}}">
            <text>{{time.getStatusText(selectedDevice.status)}}</text>
          </view>
        </view>
          <view class="detail-row">
            <text class="detail-label">设备主题:</text>
            <text class="detail-value">{{selectedDevice.topic || '未设置'}}</text>
          </view>
          <view wx:if="{{selectedDevice.longitude && selectedDevice.latitude}}" class="detail-row">
            <text class="detail-label">位置坐标:</text>
            <text class="detail-value">{{selectedDevice.longitude}}, {{selectedDevice.latitude}}</text>
          </view>
          <view wx:if="{{selectedDevice.address}}" class="detail-row">
            <text class="detail-label">地址:</text>
            <text class="detail-value">{{selectedDevice.address}}</text>
          </view>
          <view wx:if="{{currentLocation}}" class="detail-row">
            <text class="detail-label">当前位置来源:</text>
            <text class="detail-value">{{currentLocation.source === 'browser' ? '浏览器定位' :
                currentLocation.source === 'ip' ? 'IP定位' :
                currentLocation.source === 'tauri-geolocation' ? '设备GPS定位' :
                currentLocation.source}}</text>
          </view>
        </view>

        <view class="dialog-actions">
          <button
            class="action-btn primary"
            bindtap="navigateToDevice"
            disabled="{{isNavigating || !selectedDevice.longitude || !selectedDevice.latitude}}"
          >
            <text wx:if="{{isNavigating}}">正在计算路线...</text>
            <text wx:else>开始导航</text>
          </button>
          <button
            class="action-btn secondary"
            bindtap="showHistoryTrail"
          >
            <text>查看历史轨迹</text>
          </button>
        </view>
      </view>
    </view>
  </view>

  <!-- 提示消息 -->
  <view wx:if="{{alertOpen}}" class="alert-snackbar {{alertType}}">
    <text class="alert-message">{{alertMessage}}</text>
    <button class="alert-close" bindtap="handleCloseAlert">×</button>
  </view>

  <!-- 加载状态 -->
  <view wx:if="{{loading}}" class="loading-overlay">
    <view class="loading-spinner">
      <text>加载中...</text>
    </view>
  </view>
</view>
